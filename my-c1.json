{
	"$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/VM_IP.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"vmName": {
			"type": "string",
			"metadata": {
				"description": "Name of the VM"
			}
		},
		"adminUsername": {
			"type": "string",
			"metadata": {
				"description": "user name"
			}
		},
		"adminPassword": {
			"type": "securestring",
			"metadata": {
				"description": "password"
			}
		},
		"vmSize": {
			"type": "string",
			"defaultValue": "Standard_D2",
			"metadata": {
				"description": "Size of the VM"
			}
		}
	},
	"variables": {
		"apiVersion": "2015-06-15",
		"storageAccountName": "wangj85stg",
		"virtualNetworkName": "rg-test-vnet",
		"osDiskName": "[concat(parameters('vmName'), '-', uniquestring(parameters('vmName')), '-root')]",
		"nvramDiskName": "[concat(parameters('vmName'), '-', uniquestring(parameters('vmName')), '-nvram')]",
		"subnetName": "snet",
		"vmStorageAccountContainerName": "[concat(parameters('vmName'), '-', uniquestring(parameters('vmName')), '-vhds')]",
		"vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
		"subnetRef": "[concat(variables('vnetID'),'/subnets/', variables('subnetName'))]",
		"nicName": "[concat(parameters('vmName'), '-nic')]",
		"publicIPAddressName": "[concat(parameters('vmName'), '-IP')]"
	},
	"resources": [
	{
		"apiVersion": "2015-06-15",
		"type": "Microsoft.Network/publicIPAddresses",
		"name": "[variables('publicIPAddressName')]",
		"location": "[resourceGroup().location]",
		"properties": {
			"publicIPAllocationMethod": "Dynamic",
		}
	},
	{
		"apiVersion": "2015-06-15",
		"type": "Microsoft.Network/networkInterfaces",
		"name": "[variables('nicName')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
		],
		"properties": {
			"ipConfigurations": [
			{
				"name": "ipconfig1",
				"properties": {
					"privateIPAllocationMethod": "Dynamic",
					"publicIPAddress": {
						"id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"
					},
					"subnet": {
						"id": "[variables('subnetRef')]"
					}
				}
			}
			]
		}
	},
	{ 
		"apiVersion": "2015-06-15",
		"type": "Microsoft.Compute/virtualMachines",
		"name": "[parameters('vmName')]", 
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]",
			],
		"properties": {
			"hardwareProfile": {
				"vmSize": "[parameters('vmSize')]"
			},
			"storageProfile": {
				"osDisk": {
					"osType": "Linux",
					"name": "DDVE-C1-osDisk.0959152a-cb1b-4e06-9c34-f779ba70d94c.vhd",
					"createOption": "FromImage",
					"image": {
						"uri": "https://wangj85stg.blob.core.windows.net/system/Microsoft.Compute/Images/ddve-c1/DDVE-C1-osDisk.0959152a-cb1b-4e06-9c34-f779ba70d94c.vhd"
					},
					"vhd": {
						"uri": "[concat('https://', variables('storageAccountName'), '.blob.core.windows.net/', variables('vmStorageAccountContainerName'), '/', variables('osDiskName'), '.vhd')]"
					},
					"caching": "ReadWrite"
				},
				"dataDisks": [
				{
					"lun": 0,
					"name": "DDVE-C1-dataDisk-0.0959152a-cb1b-4e06-9c34-f779ba70d94c.vhd",
					"createOption": "FromImage",
					"image": {
						"uri": "https://wangj85stg.blob.core.windows.net/system/Microsoft.Compute/Images/ddve-c1/DDVE-C1-dataDisk-0.0959152a-cb1b-4e06-9c34-f779ba70d94c.vhd"
					},
					"vhd": {
						"uri": "[concat('https://', variables('storageAccountName'), '.blob.core.windows.net/', variables('vmStorageAccountContainerName'), '/', variables('nvramDiskName'), '.vhd')]"
					},
					"caching": "None"
				}
				]
			},
			"osProfile": {
				"computerName": "[parameters('vmName')]",
				"adminUsername": "[parameters('adminUsername')]",
				"adminPassword": "[parameters('adminPassword')]"
			},
			"networkProfile": {
				"networkInterfaces": [
				{
					"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]",
					"properties": { "primary": true }
				},
				]
			}
		}
	}
	]
}
